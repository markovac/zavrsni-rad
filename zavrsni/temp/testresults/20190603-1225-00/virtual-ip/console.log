TCPDUMP

moon# tcpdump -l  -i eth0 not port ssh and not port domain >/tmp/tcpdump.log 2>/tmp/tcpdump.err.log &
alice# tcpdump -l  -i eth0 not port ssh and not port domain >/tmp/tcpdump.log 2>/tmp/tcpdump.err.log &

PRE-TEST

Starting strongSwan 5.5.1 IPsec [starter]...
no netkey IPsec stack detected
no KLIPS IPsec stack detected
no known IPsec stack detected, ignoring!
Starting strongSwan 5.5.1 IPsec [starter]...
no netkey IPsec stack detected
no KLIPS IPsec stack detected
no known IPsec stack detected, ignoring!
Starting strongSwan 5.5.1 IPsec [starter]...
no netkey IPsec stack detected
no KLIPS IPsec stack detected
no known IPsec stack detected, ignoring!
50
50
initiating IKE_SA home[1] to 192.168.0.1
generating IKE_SA_INIT request 0 [ SA KE No N(NATD_S_IP) N(NATD_D_IP) N(FRAG_SUP) N(HASH_ALG) N(REDIR_SUP) ]
sending packet: from 192.168.0.100[500] to 192.168.0.1[500] (1156 bytes)
received packet: from 192.168.0.1[500] to 192.168.0.100[500] (617 bytes)
parsed IKE_SA_INIT response 0 [ SA KE No N(NATD_S_IP) N(NATD_D_IP) CERTREQ N(FRAG_SUP) N(HASH_ALG) N(MULT_AUTH) ]
received cert request for "C=CH, O=Linux strongSwan, CN=strongSwan Root CA"
sending cert request for "C=CH, O=Linux strongSwan, CN=strongSwan Root CA"
authentication of 'carol@strongswan.org' (myself) with RSA_EMSA_PKCS1_SHA2_256 successful
sending end entity cert "C=CH, O=Linux strongSwan, OU=Research, CN=carol@strongswan.org"
establishing CHILD_SA home
generating IKE_AUTH request 1 [ IDi CERT N(INIT_CONTACT) CERTREQ IDr AUTH CPRQ(ADDR DNS) N(ESP_TFC_PAD_N) SA TSi TSr N(MOBIKE_SUP) N(ADD_6_ADDR) N(MULT_AUTH) N(EAP_ONLY) ]
splitting IKE message with length of 1792 bytes into 2 fragments
generating IKE_AUTH request 1 [ EF(1/2) ]
generating IKE_AUTH request 1 [ EF(2/2) ]
sending packet: from 192.168.0.100[4500] to 192.168.0.1[4500] (1236 bytes)
sending packet: from 192.168.0.100[4500] to 192.168.0.1[4500] (644 bytes)
received packet: from 192.168.0.1[4500] to 192.168.0.100[4500] (1236 bytes)
parsed IKE_AUTH response 1 [ EF(1/2) ]
received fragment #1 of 2, waiting for complete IKE message
received packet: from 192.168.0.1[4500] to 192.168.0.100[4500] (484 bytes)
parsed IKE_AUTH response 1 [ EF(2/2) ]
received fragment #2 of 2, reassembling fragmented IKE message
parsed IKE_AUTH response 1 [ IDr CERT AUTH CPRP(ADDR) N(ESP_TFC_PAD_N) SA TSi TSr N(AUTH_LFT) N(MOBIKE_SUP) N(ADD_4_ADDR) N(ADD_6_ADDR) N(ADD_6_ADDR) ]
received end entity cert "C=CH, O=Linux strongSwan, CN=moon.strongswan.org"
  using certificate "C=CH, O=Linux strongSwan, CN=moon.strongswan.org"
  using trusted ca certificate "C=CH, O=Linux strongSwan, CN=strongSwan Root CA"
checking certificate status of "C=CH, O=Linux strongSwan, CN=moon.strongswan.org"
  fetching crl from 'http://crl.strongswan.org/strongswan.crl' ...
unable to fetch from http://crl.strongswan.org/strongswan.crl, no capable fetcher found
crl fetching failed
certificate status is not available
  reached self-signed root ca with a path length of 0
authentication of 'moon.strongswan.org' with RSA_EMSA_PKCS1_SHA2_256 successful
IKE_SA home[1] established between 192.168.0.100[carol@strongswan.org]...192.168.0.1[moon.strongswan.org]
scheduling reauthentication in 3255s
maximum IKE_SA lifetime 3435s
installing new virtual IP 10.3.0.1
created TUN device: tun0
received ESP_TFC_PADDING_NOT_SUPPORTED, not using ESPv3 TFC padding
CHILD_SA home{1} established with SPIs c5cde8e8_i cf42023a_o and TS 10.3.0.1/32 === 10.1.0.0/16
updown: /usr/local/libexec/ipsec/_updown: iptables: not found
updown: /usr/local/libexec/ipsec/_updown: iptables: not found
updown: /usr/local/libexec/ipsec/_updown: iptables: not found
updown: /usr/local/libexec/ipsec/_updown: iptables: not found
connection 'home' established successfully
50
initiating IKE_SA home[1] to 192.168.0.1
generating IKE_SA_INIT request 0 [ SA KE No N(NATD_S_IP) N(NATD_D_IP) N(FRAG_SUP) N(HASH_ALG) N(REDIR_SUP) ]
sending packet: from 192.168.0.200[500] to 192.168.0.1[500] (1156 bytes)
received packet: from 192.168.0.1[500] to 192.168.0.200[500] (617 bytes)
parsed IKE_SA_INIT response 0 [ SA KE No N(NATD_S_IP) N(NATD_D_IP) CERTREQ N(FRAG_SUP) N(HASH_ALG) N(MULT_AUTH) ]
received cert request for "C=CH, O=Linux strongSwan, CN=strongSwan Root CA"
sending cert request for "C=CH, O=Linux strongSwan, CN=strongSwan Root CA"
authentication of 'dave@strongswan.org' (myself) with RSA_EMSA_PKCS1_SHA2_256 successful
sending end entity cert "C=CH, O=Linux strongSwan, OU=Accounting, CN=dave@strongswan.org"
establishing CHILD_SA home
generating IKE_AUTH request 1 [ IDi CERT N(INIT_CONTACT) CERTREQ IDr AUTH CPRQ(ADDR DNS) N(ESP_TFC_PAD_N) SA TSi TSr N(MOBIKE_SUP) N(ADD_6_ADDR) N(MULT_AUTH) N(EAP_ONLY) ]
splitting IKE message with length of 1792 bytes into 2 fragments
generating IKE_AUTH request 1 [ EF(1/2) ]
generating IKE_AUTH request 1 [ EF(2/2) ]
sending packet: from 192.168.0.200[4500] to 192.168.0.1[4500] (1236 bytes)
sending packet: from 192.168.0.200[4500] to 192.168.0.1[4500] (628 bytes)
received packet: from 192.168.0.1[4500] to 192.168.0.200[4500] (1236 bytes)
parsed IKE_AUTH response 1 [ EF(1/2) ]
received fragment #1 of 2, waiting for complete IKE message
received packet: from 192.168.0.1[4500] to 192.168.0.200[4500] (484 bytes)
parsed IKE_AUTH response 1 [ EF(2/2) ]
received fragment #2 of 2, reassembling fragmented IKE message
parsed IKE_AUTH response 1 [ IDr CERT AUTH CPRP(ADDR) N(ESP_TFC_PAD_N) SA TSi TSr N(AUTH_LFT) N(MOBIKE_SUP) N(ADD_4_ADDR) N(ADD_6_ADDR) N(ADD_6_ADDR) ]
received end entity cert "C=CH, O=Linux strongSwan, CN=moon.strongswan.org"
  using certificate "C=CH, O=Linux strongSwan, CN=moon.strongswan.org"
  using trusted ca certificate "C=CH, O=Linux strongSwan, CN=strongSwan Root CA"
checking certificate status of "C=CH, O=Linux strongSwan, CN=moon.strongswan.org"
  fetching crl from 'http://crl.strongswan.org/strongswan.crl' ...
unable to fetch from http://crl.strongswan.org/strongswan.crl, no capable fetcher found
crl fetching failed
certificate status is not available
  reached self-signed root ca with a path length of 0
authentication of 'moon.strongswan.org' with RSA_EMSA_PKCS1_SHA2_256 successful
IKE_SA home[1] established between 192.168.0.200[dave@strongswan.org]...192.168.0.1[moon.strongswan.org]
scheduling reauthentication in 3411s
maximum IKE_SA lifetime 3591s
installing new virtual IP 10.3.0.2
failed to open : No such file or directory
created TUN device: tun1
received ESP_TFC_PADDING_NOT_SUPPORTED, not using ESPv3 TFC padding
CHILD_SA home{1} established with SPIs c3f1ba69_i ccfb65df_o and TS 10.3.0.2/32 === 10.1.0.0/16
connection 'home' established successfully

TEST

carol# ipsec status 2> /dev/null | grep 'home.*ESTABLISHED.*carol@strongswan.org.*moon.strongswan.org' [YES]
        home[1]: ESTABLISHED 3 seconds ago, 192.168.0.100[carol@strongswan.org]...192.168.0.1[moon.strongswan.org]

dave# ipsec status 2> /dev/null | grep 'home.*ESTABLISHED.*dave@strongswan.org.*moon.strongswan.org' [YES]
        home[1]: ESTABLISHED 2 seconds ago, 192.168.0.200[dave@strongswan.org]...192.168.0.1[moon.strongswan.org]

moon# ipsec status 2> /dev/null | grep 'rw\[1]: ESTABLISHED.*moon.strongswan.org.*carol@strongswan.org' [YES]
          rw[1]: ESTABLISHED 4 seconds ago, 192.168.0.1[moon.strongswan.org]...192.168.0.100[carol@strongswan.org]

moon# ipsec status 2> /dev/null | grep 'rw\[2]: ESTABLISHED.*moon.strongswan.org.*dave@strongswan.org' [YES]
          rw[2]: ESTABLISHED 3 seconds ago, 192.168.0.1[moon.strongswan.org]...192.168.0.200[dave@strongswan.org]

carol# ipsec status 2> /dev/null | grep 'home.*INSTALLED, TUNNEL' [YES]
        home{1}:  INSTALLED, TUNNEL, reqid 1, ESP SPIs: c5cde8e8_i cf42023a_o

dave# ipsec status 2> /dev/null | grep 'home.*INSTALLED, TUNNEL' [YES]
        home{1}:  INSTALLED, TUNNEL, reqid 1, ESP SPIs: c3f1ba69_i ccfb65df_o

moon# ipsec status 2> /dev/null | grep 'rw[{]1}.*INSTALLED, TUNNEL' [YES]
          rw{1}:  INSTALLED, TUNNEL, reqid 1, ESP SPIs: cf42023a_i c5cde8e8_o

moon# ipsec status 2> /dev/null | grep 'rw[{]2}.*INSTALLED, TUNNEL' [YES]
          rw{2}:  INSTALLED, TUNNEL, reqid 2, ESP SPIs: ccfb65df_i c3f1ba69_o

~~~~~~~ FAIL ~~~~~~~
moon# cat /var/log/daemon.log | grep 'peer requested virtual IP 10.3.0.1' [YES]
cat: /var/log/daemon.log: No such file or directory
~~~~~~~~~~~~~~~~~~~~

~~~~~~~ FAIL ~~~~~~~
moon# cat /var/log/daemon.log | grep 'peer requested virtual IP 10.3.0.2' [YES]
cat: /var/log/daemon.log: No such file or directory
~~~~~~~~~~~~~~~~~~~~

~~~~~~~ FAIL ~~~~~~~
moon# cat /var/log/daemon.log | grep 'assigning virtual IP 10.3.0.1 to peer' [YES]
cat: /var/log/daemon.log: No such file or directory
~~~~~~~~~~~~~~~~~~~~

~~~~~~~ FAIL ~~~~~~~
moon# cat /var/log/daemon.log | grep 'assigning virtual IP 10.3.0.2 to peer' [YES]
cat: /var/log/daemon.log: No such file or directory
~~~~~~~~~~~~~~~~~~~~

~~~~~~~ FAIL ~~~~~~~
carol# ip addr list dev eth0 | grep '10.3.0.1' [YES]
jexec: execvp: ip: No such file or directory
~~~~~~~~~~~~~~~~~~~~

~~~~~~~ FAIL ~~~~~~~
carol# ip route list table 220 | grep 'src 10.3.0.1' [YES]
jexec: execvp: ip: No such file or directory
~~~~~~~~~~~~~~~~~~~~

~~~~~~~ FAIL ~~~~~~~
dave# ip addr list dev eth0 | grep '10.3.0.2' [YES]
jexec: execvp: ip: No such file or directory
~~~~~~~~~~~~~~~~~~~~

~~~~~~~ FAIL ~~~~~~~
dave# ip route list table 220 | grep 'src 10.3.0.2' [YES]
jexec: execvp: ip: No such file or directory
~~~~~~~~~~~~~~~~~~~~

~~~~~~~ FAIL ~~~~~~~
carol# ping -c 1 10.1.0.10 | grep '64 bytes from 10.1.0.10: icmp_.eq=1' [YES]
~~ output ~~~~~~~~~~
PING 10.1.0.10 (10.1.0.10): 56 data bytes

--- 10.1.0.10 ping statistics ---
1 packets transmitted, 0 packets received, 100.0% packet loss
~~~~~~~~~~~~~~~~~~~~

~~~~~~~ FAIL ~~~~~~~
carol# ping -c 1 10.1.0.1 | grep '64 bytes from 10.1.0.1: icmp_.eq=1' [YES]
~~ output ~~~~~~~~~~
PING 10.1.0.1 (10.1.0.1): 56 data bytes
64 bytes from 10.1.0.1: icmp_seq=0 ttl=64 time=5.159 ms

--- 10.1.0.1 ping statistics ---
1 packets transmitted, 1 packets received, 0.0% packet loss
round-trip min/avg/max/stddev = 5.159/5.159/5.159/0.000 ms
~~~~~~~~~~~~~~~~~~~~

~~~~~~~ FAIL ~~~~~~~
dave# ping -c 1 10.1.0.10 | grep '64 bytes from 10.1.0.10: icmp_.eq=1' [YES]
~~ output ~~~~~~~~~~
PING 10.1.0.10 (10.1.0.10): 56 data bytes

--- 10.1.0.10 ping statistics ---
1 packets transmitted, 0 packets received, 100.0% packet loss
~~~~~~~~~~~~~~~~~~~~

~~~~~~~ FAIL ~~~~~~~
dave# ping -c 1 10.1.0.1 | grep '64 bytes from 10.1.0.1: icmp_.eq=1' [YES]
~~ output ~~~~~~~~~~
PING 10.1.0.1 (10.1.0.1): 56 data bytes
64 bytes from 10.1.0.1: icmp_seq=0 ttl=64 time=3.964 ms

--- 10.1.0.1 ping statistics ---
1 packets transmitted, 1 packets received, 0.0% packet loss
round-trip min/avg/max/stddev = 3.964/3.964/3.964/0.000 ms
~~~~~~~~~~~~~~~~~~~~

~~~~~~~ FAIL ~~~~~~~
moon# ping -c 1 10.3.0.1 | grep '64 bytes from 10.3.0.1: icmp_.eq=1' [YES]
~~ output ~~~~~~~~~~
PING 10.3.0.1 (10.3.0.1): 56 data bytes
64 bytes from 10.3.0.1: icmp_seq=0 ttl=64 time=1.218 ms

--- 10.3.0.1 ping statistics ---
1 packets transmitted, 1 packets received, 0.0% packet loss
round-trip min/avg/max/stddev = 1.218/1.218/1.218/0.000 ms
~~~~~~~~~~~~~~~~~~~~

~~~~~~~ FAIL ~~~~~~~
moon# ping -c 1 10.3.0.2 | grep '64 bytes from 10.3.0.2: icmp_.eq=1' [YES]
~~ output ~~~~~~~~~~
PING 10.3.0.2 (10.3.0.2): 56 data bytes
64 bytes from 10.3.0.2: icmp_seq=0 ttl=64 time=0.230 ms

--- 10.3.0.2 ping statistics ---
1 packets transmitted, 1 packets received, 0.0% packet loss
round-trip min/avg/max/stddev = 0.230/0.230/0.230/0.000 ms
~~~~~~~~~~~~~~~~~~~~

jexec: execvp: i=100; while [ $i -gt 0 ]; do pkill -USR1 tcpdump; tail -1 /tmp/tcpdump.err.log | perl -n -e '/(\d+).*?(\d+)/; exit ($1 == $2)' || break; sleep 0.01; i=$(($i-1)); done;: No such file or directory
moon# killall tcpdump
jexec: execvp: killall tcpdump; while true; do killall -q -0 tcpdump || break; sleep 0.01; done;: No such file or directory

~~~~~~~ FAIL ~~~~~~~
moon# cat /tmp/tcpdump.log | grep 'IP carol.strongswan.org > moon.strongswan.org: ESP' [YES]
~~~~~~~~~~~~~~~~~~~~

~~~~~~~ FAIL ~~~~~~~
moon# cat /tmp/tcpdump.log | grep 'IP moon.strongswan.org > carol.strongswan.org: ESP' [YES]
~~~~~~~~~~~~~~~~~~~~

~~~~~~~ FAIL ~~~~~~~
moon# cat /tmp/tcpdump.log | grep 'IP dave.strongswan.org > moon.strongswan.org: ESP' [YES]
~~~~~~~~~~~~~~~~~~~~

~~~~~~~ FAIL ~~~~~~~
moon# cat /tmp/tcpdump.log | grep 'IP moon.strongswan.org > dave.strongswan.org: ESP' [YES]
~~~~~~~~~~~~~~~~~~~~

jexec: execvp: i=100; while [ $i -gt 0 ]; do pkill -USR1 tcpdump; tail -1 /tmp/tcpdump.err.log | perl -n -e '/(\d+).*?(\d+)/; exit ($1 == $2)' || break; sleep 0.01; i=$(($i-1)); done;: No such file or directory
alice# killall tcpdump
jexec: execvp: killall tcpdump; while true; do killall -q -0 tcpdump || break; sleep 0.01; done;: No such file or directory

cat: /tmp/tcpdump.log: No such file or directory
~~~~~~~ FAIL ~~~~~~~
alice# cat /tmp/tcpdump.log | grep 'IP carol1.strongswan.org > alice.strongswan.org: ICMP echo request' [YES]
~~~~~~~~~~~~~~~~~~~~

cat: /tmp/tcpdump.log: No such file or directory
~~~~~~~ FAIL ~~~~~~~
alice# cat /tmp/tcpdump.log | grep 'IP alice.strongswan.org > carol1.strongswan.org: ICMP echo reply' [YES]
~~~~~~~~~~~~~~~~~~~~

cat: /tmp/tcpdump.log: No such file or directory
~~~~~~~ FAIL ~~~~~~~
alice# cat /tmp/tcpdump.log | grep 'IP dave1.strongswan.org > alice.strongswan.org: ICMP echo request' [YES]
~~~~~~~~~~~~~~~~~~~~

cat: /tmp/tcpdump.log: No such file or directory
~~~~~~~ FAIL ~~~~~~~
alice# cat /tmp/tcpdump.log | grep 'IP alice.strongswan.org > dave1.strongswan.org: ICMP echo reply' [YES]
~~~~~~~~~~~~~~~~~~~~


POST-TEST

Stopping strongSwan IPsec...
Stopping strongSwan IPsec...
Stopping strongSwan IPsec...
moon# killall tcpdump

alice# killall tcpdump

