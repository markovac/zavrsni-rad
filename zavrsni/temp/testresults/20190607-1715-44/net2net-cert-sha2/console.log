TCPDUMP

sun# tcpdump -w /tmp/tcpdump.log &

PRE-TEST

Starting strongSwan 5.5.1 IPsec [starter]...
no netkey IPsec stack detected
no KLIPS IPsec stack detected
no known IPsec stack detected, ignoring!
Starting strongSwan 5.5.1 IPsec [starter]...
no netkey IPsec stack detected
no KLIPS IPsec stack detected
no known IPsec stack detected, ignoring!
50
50
initiating IKE_SA net-net[1] to 192.168.0.2
generating IKE_SA_INIT request 0 [ SA KE No N(NATD_S_IP) N(NATD_D_IP) N(FRAG_SUP) N(HASH_ALG) N(REDIR_SUP) ]
sending packet: from 192.168.0.1[500] to 192.168.0.2[500] (1156 bytes)
received packet: from 192.168.0.2[500] to 192.168.0.1[500] (617 bytes)
parsed IKE_SA_INIT response 0 [ SA KE No N(NATD_S_IP) N(NATD_D_IP) CERTREQ N(FRAG_SUP) N(HASH_ALG) N(MULT_AUTH) ]
received cert request for "C=CH, O=Linux strongSwan, CN=strongSwan Root CA"
sending cert request for "C=CH, O=Linux strongSwan, CN=strongSwan Root CA"
authentication of 'moon.strongswan.org' (myself) with RSA_EMSA_PKCS1_SHA2_384 successful
sending end entity cert "C=CH, O=Linux strongSwan, CN=moon.strongswan.org"
establishing CHILD_SA net-net
generating IKE_AUTH request 1 [ IDi CERT N(INIT_CONTACT) CERTREQ IDr AUTH N(ESP_TFC_PAD_N) SA TSi TSr N(MULT_AUTH) N(EAP_ONLY) ]
splitting IKE message with length of 1744 bytes into 2 fragments
generating IKE_AUTH request 1 [ EF(1/2) ]
generating IKE_AUTH request 1 [ EF(2/2) ]
sending packet: from 192.168.0.1[500] to 192.168.0.2[500] (1252 bytes)
sending packet: from 192.168.0.1[500] to 192.168.0.2[500] (564 bytes)
received packet: from 192.168.0.2[500] to 192.168.0.1[500] (1252 bytes)
parsed IKE_AUTH response 1 [ EF(1/2) ]
received fragment #1 of 2, waiting for complete IKE message
received packet: from 192.168.0.2[500] to 192.168.0.1[500] (372 bytes)
parsed IKE_AUTH response 1 [ EF(2/2) ]
received fragment #2 of 2, reassembling fragmented IKE message
parsed IKE_AUTH response 1 [ IDr CERT AUTH N(ESP_TFC_PAD_N) SA TSi TSr N(AUTH_LFT) ]
received end entity cert "C=CH, O=Linux strongSwan, CN=sun.strongswan.org"
  using certificate "C=CH, O=Linux strongSwan, CN=sun.strongswan.org"
  using trusted ca certificate "C=CH, O=Linux strongSwan, CN=strongSwan Root CA"
checking certificate status of "C=CH, O=Linux strongSwan, CN=sun.strongswan.org"
  fetching crl from 'http://crl.strongswan.org/strongswan.crl' ...
unable to fetch from http://crl.strongswan.org/strongswan.crl, no capable fetcher found
crl fetching failed
certificate status is not available
  reached self-signed root ca with a path length of 0
authentication of 'sun.strongswan.org' with RSA_EMSA_PKCS1_SHA2_512 successful
IKE_SA net-net[1] established between 192.168.0.1[moon.strongswan.org]...192.168.0.2[sun.strongswan.org]
scheduling reauthentication in 3294s
maximum IKE_SA lifetime 3474s
received ESP_TFC_PADDING_NOT_SUPPORTED, not using ESPv3 TFC padding
CHILD_SA net-net{1} established with SPIs c8322855_i c9a389b7_o and TS 10.1.0.0/16 === 10.2.0.0/16
updown: /usr/local/libexec/ipsec/_updown: iptables: not found
updown: /usr/local/libexec/ipsec/_updown: iptables: not found
received AUTH_LIFETIME of 3318s, scheduling reauthentication in 3138s
connection 'net-net' established successfully

TEST

moon# cat /var/log/daemon.log | grep 'authentication of.*sun.strongswan.org.*with RSA_EMSA_PKCS1_SHA2_512 successful' [YES]
Jun  7 15:16:19 11[IKE] authentication of 'sun.strongswan.org' with RSA_EMSA_PKCS1_SHA2_512 successful

moon# ipsec status 2> /dev/null | grep 'net-net.*ESTABLISHED.*moon.strongswan.org.*sun.strongswan.org' [YES]
     net-net[1]: ESTABLISHED 1 second ago, 192.168.0.1[moon.strongswan.org]...192.168.0.2[sun.strongswan.org]

sun# cat /var/log/daemon.log | grep 'authentication of.*moon.strongswan.org.*with RSA_EMSA_PKCS1_SHA2_384 successful' [YES]
Jun  7 15:16:18 16[IKE] authentication of 'moon.strongswan.org' with RSA_EMSA_PKCS1_SHA2_384 successful

sun# ipsec status 2> /dev/null | grep 'net-net.*ESTABLISHED.*sun.strongswan.org.*moon.strongswan.org' [YES]
     net-net[1]: ESTABLISHED 2 seconds ago, 192.168.0.2[sun.strongswan.org]...192.168.0.1[moon.strongswan.org]

moon# ipsec status 2> /dev/null | grep 'net-net.*INSTALLED, TUNNEL' [YES]
     net-net{1}:  INSTALLED, TUNNEL, reqid 1, ESP SPIs: c8322855_i c9a389b7_o

sun# ipsec status 2> /dev/null | grep 'net-net.*INSTALLED, TUNNEL' [YES]
     net-net{1}:  INSTALLED, TUNNEL, reqid 1, ESP SPIs: c9a389b7_i c8322855_o

alice# ping -c 1 10.2.0.10 | grep '64 bytes from 10.2.0.10: icmp_.eq=' [YES]
64 bytes from 10.2.0.10: icmp_seq=0 ttl=62 time=4.925 ms

sun# killall tcpdump

reading from file /tmp/tcpdump.log, link-type EN10MB (Ethernet)
sun# tcpdump -r /tmp/tcpdump.log | grep 'IP 192.168.0.1 > 192.168.0.2: ESP' [YES]
15:16:22.129667 IP 192.168.0.1 > 192.168.0.2: ESP(spi=0xc9a389b7,seq=0x1), length 136

reading from file /tmp/tcpdump.log, link-type EN10MB (Ethernet)
sun# tcpdump -r /tmp/tcpdump.log | grep 'IP 192.168.0.2 > 192.168.0.1: ESP' [YES]
15:16:22.132474 IP 192.168.0.2 > 192.168.0.1: ESP(spi=0xc8322855,seq=0x1), length 136


POST-TEST

Stopping strongSwan IPsec...
Stopping strongSwan IPsec...
sun# killall tcpdump

